{% extends "base.html" %}

{% block content %}
<div class="container mt-4 mb-5">

  <!-- NAVEGACIÓN SUPERIOR -->
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <div>
      <h2 class="text-white mb-1">Reporte histórico de ventas</h2>
      <p class="text-white-50 mb-0 small">
        Análisis de boletas emitidas en el tiempo. Filtra por fecha, cliente y producto.
      </p>
    </div>

    <div class="d-flex flex-wrap gap-2">
  <a href="{% url 'caja:caja_panel' %}"
     class="btn btn-sm"
     style="background:#4b3b7a;color:#fff;">
    Caja presencial
  </a>

  <a href="{% url 'caja:cocina_panel' %}"
     class="btn btn-sm"
     style="background:#4b3b7a;color:#fff;">
    Panel cocina
  </a>

  <a href="{% url 'caja:inventario_panel' %}"
     class="btn btn-sm"
     style="background:#4b3b7a;color:#fff;">
    Reporte diario
  </a>

  <a href="{% url 'caja:reporte_ventas' %}"
     class="btn btn-sm"
     style="background:#c9ff00;color:#000;font-weight:600;">
    Reporte histórico
  </a>
</div>


  <!-- FILTROS -->
  <div class="card border-0 shadow-sm mb-4"
       style="background:rgba(0,0,0,0.9);border-radius:16px;">
    <div class="card-body text-white">
      <h5 class="mb-3">Filtros</h5>

      <form method="get" class="row g-3">

        <!-- Rango de fechas -->
        <div class="col-md-3">
          <label class="form-label small text-white-50 mb-1">Desde</label>
          <input type="date"
                 name="desde"
                 value="{{ f_desde }}"
                 class="form-control form-control-sm bg-dark text-white border-secondary">
        </div>

        <div class="col-md-3">
          <label class="form-label small text-white-50 mb-1">Hasta</label>
          <input type="date"
                 name="hasta"
                 value="{{ f_hasta }}"
                 class="form-control form-control-sm bg-dark text-white border-secondary">
        </div>

        <!-- Cliente -->
        <div class="col-md-3">
          <label class="form-label small text-white-50 mb-1">Cliente</label>
          <input type="text"
                 name="cliente"
                 value="{{ f_cliente }}"
                 placeholder="Nombre cliente"
                 class="form-control form-control-sm bg-dark text-white border-secondary">
        </div>

        <!-- Producto -->
        <div class="col-md-3">
          <label class="form-label small text-white-50 mb-1">Producto</label>
          <input type="text"
                 name="producto"
                 value="{{ f_producto }}"
                 placeholder="Nombre del producto"
                 class="form-control form-control-sm bg-dark text-white border-secondary">
        </div>

        <!-- Día / Mes / Año -->
        <div class="col-md-2">
          <label class="form-label small text-white-50 mb-1">Día</label>
          <input type="number"
                 name="dia"
                 min="1" max="31"
                 value="{{ f_dia }}"
                 placeholder="dd"
                 class="form-control form-control-sm bg-dark text-white border-secondary">
        </div>

        <div class="col-md-2">
          <label class="form-label small text-white-50 mb-1">Mes</label>
          <input type="number"
                 name="mes"
                 min="1" max="12"
                 value="{{ f_mes }}"
                 placeholder="mm"
                 class="form-control form-control-sm bg-dark text-white border-secondary">
        </div>

        <div class="col-md-2">
          <label class="form-label small text-white-50 mb-1">Año</label>
          <input type="number"
                 name="anio"
                 min="2000" max="2100"
                 value="{{ f_anio }}"
                 placeholder="aaaa"
                 class="form-control form-control-sm bg-dark text-white border-secondary">
        </div>

        <!-- Botones filtros -->
        <div class="col-md-6 d-flex align-items-end justify-content-end gap-2">
          <button type="submit"
                  class="btn btn-sm"
                  style="background:#c9ff00;color:#000;font-weight:600;">
            Aplicar filtros
          </button>
          <a href="{% url 'caja:reporte_ventas' %}"
   class="btn btn-sm btn-outline-light">
  Limpiar
</a>


        </div>
      </form>
    </div>
  </div>

  <!-- TARJETAS RESUMEN -->
  <div class="row mb-4">
    <div class="col-md-4 mb-3">
      <div class="card border-0 shadow-sm"
           style="background:rgba(0,0,0,0.85);border-radius:14px;">
        <div class="card-body text-white">
          <div class="small text-white-50 mb-1">Boletas encontradas</div>
          <div class="fs-1 fw-semibold">{{ total_boletas }}</div>
        </div>
      </div>
    </div>

    <div class="col-md-4 mb-3">
      <div class="card border-0 shadow-sm"
           style="background:rgba(0,0,0,0.85);border-radius:14px;">
        <div class="card-body text-white">
          <div class="small text-white-50 mb-1">Total vendido</div>
          <div class="fs-1 fw-semibold">
            ${{ total_general|floatformat:0 }}
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4 mb-3">
      <div class="card border-0 shadow-sm"
           style="background:rgba(0,0,0,0.85);border-radius:14px;">
        <div class="card-body text-white">
          <div class="small text-white-50 mb-1">Ticket promedio</div>
          <div class="fs-1 fw-semibold">
            ${{ ticket_promedio|floatformat:0 }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TABLA DE RESULTADOS -->
  <div class="card border-0 shadow-sm"
       style="background:rgba(0,0,0,0.9);border-radius:16px;">
    <div class="card-body text-white">

      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <div>
          <h5 class="mb-0">Boletas</h5>
          <span class="small text-white-50">
            Resultados según los filtros aplicados.
          </span>
        </div>

        <div class="d-flex flex-wrap gap-2">
         <a href="{% url 'caja:inventario_movimiento' %}"
   class="btn btn-sm"
   style="background:#4b3b7a;color:#fff;">
  Movimientos de inventario
</a>
<a href="{% url 'caja:reporte_movimientos' %}"
   class="btn btn-sm"
   style="background:#4b3b7a;color:#fff;">
  Gráfico de movimientos
</a>

          <button type="button"
                  class="btn btn-sm"
                  style="background:#c9ff00;color:#000;font-weight:600;">
            Exportar a Excel
          </button>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-sm table-dark table-hover align-middle mb-0">
          <thead class="align-middle" style="background:rgba(255,255,255,0.04);">
            <tr>
              <th style="width:90px;">Folio</th>
              <th style="width:160px;">Fecha / hora</th>
              <th>Cliente</th>
              <th style="width:120px;">Origen</th>
              <th style="width:140px;">Medio de pago</th>
              <th class="text-end" style="width:140px;">Total</th>
              <th class="text-center" style="width:180px;">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for p in pedidos %}
              <tr>
                <td class="fw-semibold">
  {% if p.boleta %}
    #{{ p.boleta.folio }}
  {% else %}
    -
  {% endif %}
</td>


                <td class="text-white-50">
                  {{ p.creado_en|date:"d/m/Y H:i" }}
                </td>

                <td>
                  {{ p.nombre_cliente|default:"(Sin nombre)" }}
                </td>

                <td>
                  {{ p.get_origen_display }}
                </td>

                <td>
                  {% if p.forma_pago == "efectivo" %}
                    <span class="badge bg-success">Efectivo</span>
                  {% elif p.forma_pago == "transferencia" %}
                    <span class="badge bg-info text-dark">Transferencia</span>
                  {% elif p.forma_pago == "tarjeta" %}
                    <span class="badge bg-warning text-dark">Tarjeta</span>
                  {% else %}
                    <span class="badge bg-secondary">No definido</span>
                  {% endif %}
                </td>

                <td class="text-end fw-semibold">
                  ${{ p.total|floatformat:0 }}
                </td>

                <td class="text-center">
                  <div class="btn-group btn-group-sm" role="group">
                    <a href="{% url 'caja:caja_ver_boleta' p.id %}"
   class="btn btn-outline-light">
  Ver
</a>
<a href="{% url 'caja:boleta_pdf' p.id %}"
   class="btn btn-outline-light">
  PDF
</a>

                  </div>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="7" class="text-center text-white-50 py-4">
                  No se encontraron ventas con los filtros seleccionados.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="mt-3 d-flex justify-content-between flex-wrap gap-2">
        <small class="text-white-50">
          Para un análisis diario rápido, usa el <strong>Reporte diario de ventas</strong>.
        </small>
        <small class="text-white-50">
          Módulo de Caja · Quincho Videla
        </small>
      </div>

    </div>
  </div>

</div>
{% endblock %}
